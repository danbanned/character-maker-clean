<!-- views/character-create.ejs -->

<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;800;900&family=Nunito+Sans:wght@400;600;700&display=swap');

  :root {
    --k-dark:      #1a0533;
    --k-purple:    #46178f;
    --k-red:       #e21b3c;
    --k-blue:      #1368ce;
    --k-yellow:    #d89e00;
    --k-green:     #26890c;
    --neon-purple: #8c52ff;
    --neon-cyan:   #00cfff;
    --neon-yellow: #ffe234;
    --neon-pink:   #ff3d9a;
  }

  body, .cc-wrapper {
    background: var(--k-dark) !important;
    font-family: 'Nunito Sans', sans-serif;
    color: #fff;
    min-height: 100vh;
  }

  /* â”€â”€ STAR FIELD â”€â”€ */
  .star-field { position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden; }
  .star {
    position:absolute; border-radius:50%; background:#fff; opacity:0;
    animation: twinkle var(--dur) ease-in-out infinite;
  }
  @keyframes twinkle {
    0%,100% { opacity:0; transform:scale(0.5); }
    50%      { opacity:0.7; transform:scale(1); }
  }

  /* â”€â”€ PAGE WRAP â”€â”€ */
  .cc-wrapper {
    position: relative;
    z-index: 10;
    max-width: 1100px;
    margin: 0 auto;
    padding: 30px 20px 80px;
  }

  /* â”€â”€ TOP BAR â”€â”€ */
  .cc-topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 36px;
    flex-wrap: wrap;
    gap: 14px;
  }
  .cc-title {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: clamp(1.8rem, 4vw, 2.8rem);
    letter-spacing: -1px;
    text-shadow: 0 4px 20px rgba(140,82,255,0.7);
    margin: 0;
  }
  .cc-title span { color: var(--neon-yellow); }

  .btn-back {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 0.9rem;
    padding: 12px 22px;
    background: rgba(255,255,255,0.1);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 10px;
    text-decoration: none;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    transition: all 0.2s;
    backdrop-filter: blur(4px);
  }
  .btn-back:hover { background:rgba(255,255,255,0.2); color:#fff; text-decoration:none; transform:translateX(-3px); }

  /* â”€â”€ MAIN LAYOUT â”€â”€ */
  .cc-layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    align-items: start;
  }
  @media (max-width: 820px) { .cc-layout { grid-template-columns: 1fr; } }

  /* â”€â”€ SHARED CARD â”€â”€ */
  .k-card {
    background: linear-gradient(145deg, rgba(70,23,143,0.5), rgba(26,5,51,0.7));
    border: 1px solid rgba(140,82,255,0.3);
    border-radius: 20px;
    padding: 24px;
    backdrop-filter: blur(8px);
    box-shadow: 0 8px 40px rgba(0,0,0,0.4);
    position: relative;
    overflow: hidden;
    margin-bottom: 18px;
  }
  .k-card::before {
    content:''; position:absolute; inset:0;
    background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, transparent 60%);
    pointer-events:none;
  }
  .k-card:last-child { margin-bottom: 0; }

  .k-card-title {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--neon-cyan);
    margin: 0 0 20px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .k-card-title::after {
    content:''; flex:1; height:2px;
    background: linear-gradient(90deg, var(--neon-cyan), transparent);
    border-radius:2px; opacity:0.4;
  }

  /* â”€â”€ AVATAR PREVIEW CARD â”€â”€ */
  .avatar-preview-card {
    background: linear-gradient(160deg, #3b0764, #1a0533);
    border: 2px solid var(--neon-purple);
    box-shadow: 0 0 40px rgba(140,82,255,0.25), 0 8px 40px rgba(0,0,0,0.5);
    text-align: center;
    position: sticky;
    top: 20px;
  }
  #liveAvatar {
    min-height: 240px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 10px 0 16px;
    position: relative;
  }
  #liveAvatar > .av-inner {
    animation: floatBig 3s ease-in-out infinite;
    filter: drop-shadow(0 10px 24px rgba(140,82,255,0.6));
  }
  @keyframes floatBig {
    0%,100% { transform:translateY(0px) rotate(-0.5deg); }
    50%      { transform:translateY(-12px) rotate(0.5deg); }
  }
  .avatar-aura {
    position:absolute; width:160px; height:160px; border-radius:50%;
    background: radial-gradient(circle, rgba(140,82,255,0.25) 0%, transparent 70%);
    animation: pulseAura 2.5s ease-in-out infinite;
    top:50%; left:50%; transform:translate(-50%,-50%); pointer-events:none;
  }
  @keyframes pulseAura {
    0%,100% { transform:translate(-50%,-50%) scale(1); opacity:0.6; }
    50%      { transform:translate(-50%,-50%) scale(1.2); opacity:1; }
  }

  .preview-name {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.2rem;
    margin: 0 0 6px;
    color: var(--neon-yellow);
    text-shadow: 0 2px 10px rgba(255,226,52,0.4);
    min-height: 1.5em;
  }
  .preview-sub {
    font-size: 0.8rem;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: rgba(255,255,255,0.45);
    margin-bottom: 16px;
  }

  .btn-randomize {
    width: 100%;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 0.85rem;
    padding: 12px;
    background: linear-gradient(135deg, #7c3aed, #4c1d95);
    color: #fff;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 4px 0 #2e1065, 0 4px 16px rgba(124,58,237,0.4);
    transition: all 0.2s;
    margin-top: 8px;
  }
  .btn-randomize:hover { transform:translateY(-2px); box-shadow:0 6px 0 #2e1065, 0 8px 24px rgba(124,58,237,0.5); }
  .btn-randomize:active { transform:translateY(2px); box-shadow:0 2px 0 #2e1065; }

  .btn-suggest-name {
    width: 100%;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 0.82rem;
    padding: 10px;
    background: rgba(255,255,255,0.08);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .btn-suggest-name:hover { background:rgba(255,255,255,0.15); }

  /* â”€â”€ FORM ELEMENTS â”€â”€ */
  .form-row {
    display: grid;
    gap: 14px;
    margin-bottom: 14px;
  }
  .form-row.cols-2 { grid-template-columns: 1fr 1fr; }
  .form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
  @media (max-width: 600px) {
    .form-row.cols-2, .form-row.cols-3 { grid-template-columns: 1fr; }
  }

  .form-group { display:flex; flex-direction:column; gap:6px; }
  .form-label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: rgba(255,255,255,0.5);
    font-weight: 700;
  }

  input[type="text"],
  input[type="number"],
  select,
  textarea {
    background: rgba(255,255,255,0.07) !important;
    border: 1px solid rgba(255,255,255,0.15) !important;
    border-radius: 10px !important;
    color: #fff !important;
    padding: 11px 14px !important;
    font-family: 'Nunito Sans', sans-serif !important;
    font-size: 0.95rem !important;
    font-weight: 600 !important;
    width: 100% !important;
    box-sizing: border-box !important;
    transition: border-color 0.2s, box-shadow 0.2s !important;
    outline: none !important;
    appearance: none !important;
  }
  input[type="text"]:focus,
  input[type="number"]:focus,
  select:focus,
  textarea:focus {
    border-color: var(--neon-purple) !important;
    box-shadow: 0 0 0 3px rgba(140,82,255,0.2) !important;
    background: rgba(255,255,255,0.1) !important;
  }
  select option { background: #2d0a5e; color: #fff; }
  input::placeholder { color: rgba(255,255,255,0.25) !important; }

  /* name field special */
  #name-input {
    font-family: 'Nunito', sans-serif !important;
    font-weight: 900 !important;
    font-size: 1.2rem !important;
    border-color: rgba(255,226,52,0.3) !important;
  }
  #name-input:focus { border-color: var(--neon-yellow) !important; box-shadow: 0 0 0 3px rgba(255,226,52,0.15) !important; }

  /* â”€â”€ STAT SLIDERS â”€â”€ */
  .stat-sliders {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
  }
  @media (max-width: 600px) { .stat-sliders { grid-template-columns: 1fr; } }

  .stat-row {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 12px 14px;
    transition: border-color 0.2s;
  }
  .stat-row:hover { border-color: rgba(140,82,255,0.4); }

  .stat-row-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .stat-row-label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: rgba(255,255,255,0.5);
    font-weight: 700;
  }
  .stat-row-val {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.2rem;
    color: #fff;
    min-width: 30px;
    text-align: right;
  }

  input[type="range"] {
    -webkit-appearance: none !important;
    appearance: none !important;
    width: 100% !important;
    height: 6px !important;
    border-radius: 3px !important;
    background: rgba(255,255,255,0.15) !important;
    border: none !important;
    padding: 0 !important;
    cursor: pointer !important;
    box-shadow: none !important;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--neon-purple);
    box-shadow: 0 0 8px rgba(140,82,255,0.8);
    cursor: pointer;
    transition: transform 0.15s;
  }
  input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.25); }
  input[type="range"]:nth-of-type(1) { --track-color: #e21b3c; }

  /* Color-code each stat's thumb */
  .stat-row:nth-child(1) input[type="range"]::-webkit-slider-thumb { background:#e21b3c; box-shadow:0 0 8px rgba(226,27,60,0.7); }
  .stat-row:nth-child(2) input[type="range"]::-webkit-slider-thumb { background:#26890c; box-shadow:0 0 8px rgba(38,137,12,0.7); }
  .stat-row:nth-child(3) input[type="range"]::-webkit-slider-thumb { background:#1368ce; box-shadow:0 0 8px rgba(19,104,206,0.7); }
  .stat-row:nth-child(4) input[type="range"]::-webkit-slider-thumb { background:#8c52ff; box-shadow:0 0 8px rgba(140,82,255,0.7); }
  .stat-row:nth-child(5) input[type="range"]::-webkit-slider-thumb { background:#d89e00; box-shadow:0 0 8px rgba(216,158,0,0.7); }
  .stat-row:nth-child(6) input[type="range"]::-webkit-slider-thumb { background:#ff3d9a; box-shadow:0 0 8px rgba(255,61,154,0.7); }

  /* â”€â”€ COLOR PICKER ROWS â”€â”€ */
  .color-picker-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  input[type="color"] {
    -webkit-appearance: none !important;
    appearance: none !important;
    width: 44px !important;
    height: 40px !important;
    border: none !important;
    border-radius: 8px !important;
    padding: 2px !important;
    background: rgba(255,255,255,0.1) !important;
    cursor: pointer !important;
    flex-shrink: 0 !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important;
  }
  input[type="color"]::-webkit-color-swatch-wrapper { padding:2px; }
  input[type="color"]::-webkit-color-swatch { border:none; border-radius:6px; }

  /* â”€â”€ SELECT BUTTON GROUPS (appearance pills) â”€â”€ */
  .pill-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .pill {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 0.78rem;
    padding: 7px 14px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.6);
    cursor: pointer;
    transition: all 0.15s;
    text-transform: capitalize;
    letter-spacing: 0.3px;
    user-select: none;
  }
  .pill:hover { background:rgba(255,255,255,0.1); color:#fff; }
  .pill.active {
    background: var(--neon-purple);
    border-color: var(--neon-purple);
    color: #fff;
    box-shadow: 0 0 12px rgba(140,82,255,0.5);
  }

  /* â”€â”€ SUBMIT BUTTON â”€â”€ */
  .btn-submit {
    width: 100%;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.15rem;
    padding: 18px;
    background: var(--k-green);
    color: #fff;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 6px 0 #1a5c08, 0 8px 30px rgba(38,137,12,0.45);
    transition: all 0.2s;
    margin-top: 8px;
  }
  .btn-submit:hover { background:#2ea30d; transform:translateY(-2px); box-shadow:0 8px 0 #1a5c08, 0 12px 36px rgba(38,137,12,0.5); }
  .btn-submit:active { transform:translateY(3px); box-shadow:0 3px 0 #1a5c08; }

  /* â”€â”€ HIDDEN INPUTS â”€â”€ */
  .hidden-inputs { display:none; }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position:fixed; bottom:30px; left:50%;
    transform:translateX(-50%) translateY(100px);
    background:#7c3aed; color:#fff; padding:14px 28px;
    border-radius:50px; font-family:'Nunito',sans-serif;
    font-weight:900; font-size:1rem;
    box-shadow:0 8px 30px rgba(124,58,237,0.6);
    z-index:9999; transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
    white-space:nowrap;
  }
  #toast.show { transform:translateX(-50%) translateY(0); }

  /* â”€â”€ FLASH MESSAGES â”€â”€ */
  .flash-msg {
    border-radius:10px; padding:12px 18px; font-weight:700; margin-bottom:16px;
  }
  .flash-error   { background:rgba(226,27,60,0.3); border:1px solid #e21b3c; }
  .flash-success { background:rgba(38,137,12,0.3); border:1px solid #26890c; }
</style>

<!-- Star field -->
<div class="star-field" id="starField"></div>

<div class="cc-wrapper">

  <!-- Top bar -->
  <div class="cc-topbar">
    <h2 class="cc-title">ğŸ§ Create <span>Character</span></h2>
    <a href="/dashboard" class="btn-back">â† Dashboard</a>
  </div>

  <!-- Flash messages -->
  <% if (messages && messages.error && messages.error.length) { %>
    <div class="flash-msg flash-error">âš ï¸ <%= messages.error[0] %></div>
  <% } %>

  <form action="/character/create" method="POST" id="createForm">

    <!-- Hidden appearance inputs (populated by JS) -->
    <div class="hidden-inputs">
      <input type="hidden" name="skinColor"  id="h-skinColor"  value="#fdd5b1">
      <input type="hidden" name="hairColor"  id="h-hairColor"  value="#3d2817">
      <input type="hidden" name="hairStyle"  id="h-hairStyle"  value="short">
      <input type="hidden" name="eyeColor"   id="h-eyeColor"   value="#4a90e2">
      <input type="hidden" name="bodyType"   id="h-bodyType"   value="average">
      <input type="hidden" name="armor"      id="h-armor"      value="leather">
      <input type="hidden" name="armorColor" id="h-armorColor" value="#8b4513">
      <input type="hidden" name="weapon"     id="h-weapon"     value="sword">
      <input type="hidden" name="accessory"  id="h-accessory"  value="none">
    </div>

    <div class="cc-layout">

      <!-- â”€â”€ LEFT: Live avatar preview â”€â”€ -->
      <div>
        <div class="k-card avatar-preview-card">
          <div class="k-card-title">ğŸ‘ Live Preview</div>

          <div id="liveAvatar">
            <div class="avatar-aura"></div>
            <div class="av-inner" id="avatarInner"></div>
          </div>

          <div class="preview-name" id="previewName">Your Hero</div>
          <div class="preview-sub" id="previewSub">Choose race & class</div>

          <button type="button" class="btn-randomize" onclick="randomizeAll()">
            ğŸ² Randomize Appearance
          </button>
          <button type="button" class="btn-suggest-name" onclick="suggestName()">
            ğŸ’¡ Suggest a Name
          </button>
        </div>
      </div>

      <!-- â”€â”€ RIGHT: Form panels â”€â”€ -->
      <div>

        <!-- Identity -->
        <div class="k-card">
          <div class="k-card-title">ğŸªª Identity</div>

          <div class="form-group" style="margin-bottom:14px;">
            <label class="form-label" for="name-input">Character Name</label>
            <input type="text" id="name-input" name="name"
                   placeholder="Enter a legendary nameâ€¦" required
                   oninput="updatePreview()">
          </div>

          <div class="form-row cols-2">
            <div class="form-group">
              <label class="form-label">Race</label>
              <select name="race" id="sel-race" onchange="updatePreview()">
                <option value="Human">ğŸ§‘ Human</option>
                <option value="Elf">ğŸ§ Elf</option>
                <option value="Dwarf">â›ï¸ Dwarf</option>
                <option value="Halfling">ğŸ€ Halfling</option>
                <option value="Orc">ğŸ’š Orc</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Class</label>
              <select name="class" id="sel-class" onchange="updatePreview()">
                <option value="Warrior">âš”ï¸ Warrior</option>
                <option value="Mage">ğŸ”® Mage</option>
                <option value="Rogue">ğŸ—¡ï¸ Rogue</option>
                <option value="Cleric">âœ¨ Cleric</option>
                <option value="Ranger">ğŸ¹ Ranger</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Level</label>
            <input type="number" name="level" value="1" min="1" max="20">
          </div>
        </div>

        <!-- Stats -->
        <div class="k-card">
          <div class="k-card-title">ğŸ“Š Stats</div>
          <div class="stat-sliders">
            <% [
              ['strength','Strength','ğŸ’ª'],
              ['dexterity','Dexterity','ğŸƒ'],
              ['constitution','Constitution','ğŸ›¡ï¸'],
              ['intelligence','Intelligence','ğŸ§ '],
              ['wisdom','Wisdom','ğŸ¦‰'],
              ['charisma','Charisma','âœ¨']
            ].forEach(([field, label, icon]) => { %>
            <div class="stat-row">
              <div class="stat-row-top">
                <span class="stat-row-label"><%= icon %> <%= label %></span>
                <span class="stat-row-val" id="val-<%= field %>">10</span>
              </div>
              <input type="range" name="<%= field %>" id="range-<%= field %>"
                     min="1" max="20" value="10"
                     oninput="document.getElementById('val-<%= field %>').textContent=this.value">
            </div>
            <% }) %>
          </div>
        </div>

        <!-- Appearance -->
        <div class="k-card">
          <div class="k-card-title">ğŸ¨ Appearance</div>

          <!-- Skin & Hair colors -->
          <div class="form-row cols-3" style="margin-bottom:18px;">
            <div class="form-group">
              <label class="form-label">Skin Color</label>
              <div class="color-picker-row">
                <input type="color" id="skinColor" value="#fdd5b1"
                       oninput="syncColor('skinColor'); rerenderAvatar()">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Hair Color</label>
              <div class="color-picker-row">
                <input type="color" id="hairColor" value="#3d2817"
                       oninput="syncColor('hairColor'); rerenderAvatar()">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Eye Color</label>
              <div class="color-picker-row">
                <input type="color" id="eyeColor" value="#4a90e2"
                       oninput="syncColor('eyeColor'); rerenderAvatar()">
              </div>
            </div>
          </div>

          <!-- Hair style -->
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">Hair Style</label>
            <div class="pill-group" id="pg-hairStyle">
              <div class="pill active" data-val="short"   onclick="selectPill('hairStyle','short',this)">Short</div>
              <div class="pill"        data-val="long"    onclick="selectPill('hairStyle','long',this)">Long</div>
              <div class="pill"        data-val="bald"    onclick="selectPill('hairStyle','bald',this)">Bald</div>
              <div class="pill"        data-val="mohawk"  onclick="selectPill('hairStyle','mohawk',this)">Mohawk</div>
            </div>
          </div>

          <!-- Body type -->
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">Body Type</label>
            <div class="pill-group" id="pg-bodyType">
              <div class="pill"        data-val="slim"     onclick="selectPill('bodyType','slim',this)">Slim</div>
              <div class="pill active" data-val="average"  onclick="selectPill('bodyType','average',this)">Average</div>
              <div class="pill"        data-val="muscular" onclick="selectPill('bodyType','muscular',this)">Muscular</div>
            </div>
          </div>

          <!-- Armor -->
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">Armor</label>
            <div class="pill-group" id="pg-armor">
              <div class="pill active" data-val="leather" onclick="selectPill('armor','leather',this)">Leather</div>
              <div class="pill"        data-val="chain"   onclick="selectPill('armor','chain',this)">Chain</div>
              <div class="pill"        data-val="plate"   onclick="selectPill('armor','plate',this)">Plate</div>
              <div class="pill"        data-val="robe"    onclick="selectPill('armor','robe',this)">Robe</div>
            </div>
          </div>

          <!-- Armor color -->
          <div class="form-row cols-2" style="margin-bottom:16px;">
            <div class="form-group">
              <label class="form-label">Armor Color</label>
              <div class="color-picker-row">
                <input type="color" id="armorColor" value="#8b4513"
                       oninput="syncColor('armorColor'); rerenderAvatar()">
              </div>
            </div>
          </div>

          <!-- Weapon -->
          <div class="form-group" style="margin-bottom:16px;">
            <label class="form-label">Weapon</label>
            <div class="pill-group" id="pg-weapon">
              <div class="pill active" data-val="sword" onclick="selectPill('weapon','sword',this)">âš”ï¸ Sword</div>
              <div class="pill"        data-val="axe"   onclick="selectPill('weapon','axe',this)">ğŸª“ Axe</div>
              <div class="pill"        data-val="staff" onclick="selectPill('weapon','staff',this)">ğŸª„ Staff</div>
              <div class="pill"        data-val="bow"   onclick="selectPill('weapon','bow',this)">ğŸ¹ Bow</div>
            </div>
          </div>

          <!-- Accessory -->
          <div class="form-group">
            <label class="form-label">Accessory</label>
            <div class="pill-group" id="pg-accessory">
              <div class="pill active" data-val="none"  onclick="selectPill('accessory','none',this)">None</div>
              <div class="pill"        data-val="cape"  onclick="selectPill('accessory','cape',this)">ğŸ¦¸ Cape</div>
              <div class="pill"        data-val="crown" onclick="selectPill('accessory','crown',this)">ğŸ‘‘ Crown</div>
              <div class="pill"        data-val="scarf" onclick="selectPill('accessory','scarf',this)">ğŸ§£ Scarf</div>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="k-card">
          <button type="submit" class="btn-submit">âš”ï¸ Forge This Character!</button>
        </div>

      </div><!-- /right col -->
    </div><!-- /cc-layout -->
  </form>
</div>

<div id="toast"></div>
<script src="/js/avatarRenderer.js"></script>

<script>
// â”€â”€ Star field â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const sf = document.getElementById('starField');
  for (let i = 0; i < 80; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const sz = Math.random()*3+1;
    s.style.cssText = `width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${(Math.random()*3+2).toFixed(1)}s;animation-delay:${(Math.random()*4).toFixed(1)}s;`;
    sf.appendChild(s);
  }
})();

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€ Current appearance state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const appearance = {
  skinColor:  '#fdd5b1',
  hairColor:  '#3d2817',
  hairStyle:  'short',
  eyeColor:   '#4a90e2',
  bodyType:   'average',
  armor:      'leather',
  armorColor: '#8b4513',
  weapon:     'sword',
  accessory:  'none'
};

// â”€â”€ Pill selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectPill(field, val, el) {
  document.querySelectorAll(`#pg-${field} .pill`).forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  appearance[field] = val;
  document.getElementById(`h-${field}`).value = val;
  rerenderAvatar();
}

// â”€â”€ Color sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncColor(field) {
  appearance[field] = document.getElementById(field).value;
  document.getElementById(`h-${field}`).value = appearance[field];
}

// â”€â”€ Update preview name/sub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePreview() {
  const name = document.getElementById('name-input').value.trim();
  const race = document.getElementById('sel-race').value;
  const cls  = document.getElementById('sel-class').value;
  document.getElementById('previewName').textContent = name || 'Your Hero';
  document.getElementById('previewSub').textContent  = `${race} Â· ${cls}`;
  rerenderAvatar();
}

// â”€â”€ Render avatar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rerenderAvatar() {
  const el = document.getElementById('avatarInner');
  if (el && window.avatarRenderer) {
    el.innerHTML = window.avatarRenderer.generateSVG(appearance, 200, {
      animated: true, animationType: 'idle'
    });
  }
}

// â”€â”€ Randomize all appearance fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function randomizeAll() {
  try {
    const res = await fetch('/character/randomize-appearance', { method:'POST', headers:{'Content-Type':'application/json'} });
    const data = await res.json();
    Object.assign(appearance, data);

    // Sync hidden inputs
    Object.keys(data).forEach(k => {
      const el = document.getElementById(`h-${k}`);
      if (el) el.value = data[k];
    });

    // Sync color pickers
    ['skinColor','hairColor','eyeColor','armorColor'].forEach(k => {
      const cp = document.getElementById(k);
      if (cp) cp.value = data[k];
    });

    // Sync pills
    ['hairStyle','bodyType','armor','weapon','accessory'].forEach(k => {
      if (!data[k]) return;
      document.querySelectorAll(`#pg-${k} .pill`).forEach(p => {
        p.classList.toggle('active', p.dataset.val === data[k]);
      });
    });

    rerenderAvatar();
    showToast('ğŸ² Randomized!');
  } catch(e) {
    // Fallback: randomize client-side
    const randoms = {
      skinColor:  ['#fdd5b1','#f1c27d','#e0ac69','#c68642','#8d5524'][Math.floor(Math.random()*5)],
      hairColor:  ['#000000','#3d2817','#8b4513','#daa520','#ffffff'][Math.floor(Math.random()*5)],
      hairStyle:  ['short','long','bald','mohawk'][Math.floor(Math.random()*4)],
      eyeColor:   ['#4a90e2','#2ecc71','#8b4513','#95a5a6'][Math.floor(Math.random()*4)],
      bodyType:   ['slim','average','muscular'][Math.floor(Math.random()*3)],
      armor:      ['leather','plate','robe','chain'][Math.floor(Math.random()*4)],
      armorColor: ['#8b4513','#4a4a4a','#2c3e50','#c0392b'][Math.floor(Math.random()*4)],
      weapon:     ['sword','axe','staff','bow'][Math.floor(Math.random()*4)],
      accessory:  ['none','cape','crown','scarf'][Math.floor(Math.random()*4)]
    };
    Object.assign(appearance, randoms);
    Object.keys(randoms).forEach(k => {
      const h = document.getElementById(`h-${k}`); if (h) h.value = randoms[k];
      const cp = document.getElementById(k); if (cp) cp.value = randoms[k];
    });
    ['hairStyle','bodyType','armor','weapon','accessory'].forEach(k => {
      document.querySelectorAll(`#pg-${k} .pill`).forEach(p =>
        p.classList.toggle('active', p.dataset.val === randoms[k])
      );
    });
    rerenderAvatar();
    showToast('ğŸ² Randomized!');
  }
}

// â”€â”€ Suggest name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function suggestName() {
  const race = document.getElementById('sel-race').value;
  const cls  = document.getElementById('sel-class').value;
  try {
    const res  = await fetch('/ai/suggest-name', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ race, charClass: cls })
    });
    const data = await res.json();
    if (data.name) {
      document.getElementById('name-input').value = data.name;
      updatePreview();
      showToast(`ğŸ’¡ Suggested: ${data.name}`);
    }
  } catch(e) {
    showToast('âš ï¸ Could not suggest a name');
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  rerenderAvatar();
  updatePreview();

  // Live stat label sync (belt & braces)
  ['strength','dexterity','constitution','intelligence','wisdom','charisma'].forEach(f => {
    const r = document.getElementById(`range-${f}`);
    const v = document.getElementById(`val-${f}`);
    if (r && v) r.addEventListener('input', () => v.textContent = r.value);
  });
});
</script>
